name: Automatic Plugin Release

on:
  push:
    branches:
      - Master
    paths:
      - 'manifest.json'

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Read Manifest Version
        id: get_version
        run: |
          VERSION=$(jq -r .version manifest.json)
          echo "Detected Version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          TAG=v$VERSION
          # Create the release using GitHub's API
          RESPONSE=$(curl -s -X POST https://api.github.com/repos/${{ github.repository }}/releases \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -d @- << EOF
          {
            "tag_name": "$TAG",
            "name": "Release $TAG",
            "body": "Release notes for version $TAG",
            "draft": false,
            "prerelease": false
          }
          EOF
          )
          # Extract the upload_url from the response
          UPLOAD_URL=$(echo $RESPONSE | jq -r .upload_url | sed "s/{?name,label}//")
          echo "UPLOAD_URL=$UPLOAD_URL" >> $GITHUB_ENV
          
      - name: Zip Plugin Contents
        run: |
          zip -r custom-craft-component.zip . \
          -x '.git*' \
          -x '.github*' \
          -x '*.md' \
          -x 'LICENSE'

      - name: Upload Release Asset
        run: |
          echo "Uploading plugin asset..."
          curl -X POST $UPLOAD_URL \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -F "file=@custom-craft-component.zip" \
            -F "name=custom-craft-component.zip" \
            -F "label=custom-craft-component.zip"
